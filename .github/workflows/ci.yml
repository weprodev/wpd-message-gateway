name: CI

on:
  pull_request:
    branches: [master]

env:
  GO_VERSION: "1.25"
  NODE_VERSION: "20"

jobs:
  lint:
    name: üîç Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Check formatting
        run: |
          UNFORMATTED=$(gofmt -l . | grep -v vendor || true)
          if [ -n "$UNFORMATTED" ]; then
            echo "::error::Code not formatted. Run 'gofmt -w .'"
            echo "$UNFORMATTED"
            exit 1
          fi

      - name: Install and run golangci-lint
        run: |
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.8.0
          golangci-lint run --timeout=5m

      - name: Summary
        if: always()
        run: |
          echo "## üîç Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ All checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Lint checks failed" >> $GITHUB_STEP_SUMMARY
          fi

  test:
    name: üß™ Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run tests
        run: |
          go test -race -coverprofile=coverage.out -covermode=atomic ./... 2>&1 | tee test-output.txt
          echo "TEST_EXIT_CODE=${PIPESTATUS[0]}" >> $GITHUB_ENV

      - name: Upload coverage
        if: success()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          fail_ci_if_error: false

      - name: Summary
        if: always()
        run: |
          echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract test stats
          PASSED=$(grep -c "^--- PASS" test-output.txt 2>/dev/null || echo "0")
          FAILED=$(grep -c "^--- FAIL" test-output.txt 2>/dev/null || echo "0")

          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY

          # Show coverage if available
          if [ -f coverage.out ]; then
            COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
            echo "| üìä Coverage | $COVERAGE |" >> $GITHUB_STEP_SUMMARY
          fi

  build:
    name: üî® Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build packages
        run: go build ./...

      - name: Build server
        run: |
          go build -ldflags="-s -w" -o bin/server ./cmd/server
          ls -lh bin/server

      - name: Summary
        run: |
          echo "## üî® Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Binary | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          SIZE=$(ls -lh bin/server | awk '{print $5}')
          echo "| server | $SIZE |" >> $GITHUB_STEP_SUMMARY

  security:
    name: üîí Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./... 2>&1 | tee vuln-output.txt || true

      - name: Summary
        run: |
          echo "## üîí Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if grep -q "No vulnerabilities found" vuln-output.txt; then
            echo "‚úÖ No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Review vulnerability report in logs" >> $GITHUB_STEP_SUMMARY
          fi

  api-test:
    name: üåê API Test (Bruno)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build and start server
        run: |
          go build -o bin/server ./cmd/server
          CONFIG_PATH=configs/local.example.yml ./bin/server &

          # Wait for server
          for i in {1..30}; do
            if curl -s http://localhost:10101/health > /dev/null 2>&1; then
              echo "Server ready"
              break
            fi
            sleep 1
          done

      - name: Install Bruno CLI
        run: npm install -g @usebruno/cli

      - name: Run API tests
        id: bruno
        run: |
          cd tests/bruno
          bru run --env memory 2>&1 | tee bruno-output.txt
          echo "BRUNO_EXIT=$?" >> $GITHUB_ENV

      - name: Stop server
        if: always()
        run: pkill -f "bin/server" || true

      - name: Summary
        if: always()
        run: |
          echo "## üåê Bruno API Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f tests/bruno/bruno-output.txt ]; then
            # Count results
            TOTAL=$(grep -c "Request:" tests/bruno/bruno-output.txt 2>/dev/null || echo "0")
            PASSED=$(grep -c "‚úì" tests/bruno/bruno-output.txt 2>/dev/null || echo "0")
            FAILED=$(grep -c "‚úó" tests/bruno/bruno-output.txt 2>/dev/null || echo "0")
            
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| üìã Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ùå Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "<details><summary>üìù Full Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat tests/bruno/bruno-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è No test output found" >> $GITHUB_STEP_SUMMARY
          fi

  web:
    name: üé® Web UI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Install & Build
        run: |
          cd web
          npm ci
          npm run build

      - name: Summary
        run: |
          echo "## üé® Web UI Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "web/dist" ]; then
            SIZE=$(du -sh web/dist | cut -f1)
            echo "‚úÖ Build successful ($SIZE)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Build failed" >> $GITHUB_STEP_SUMMARY
          fi

  # Final summary
  summary:
    name: üìä Summary
    needs: [lint, test, build, security, api-test, web]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## üìä CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üîç Lint | ${{ needs.lint.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üß™ Test | ${{ needs.test.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üî® Build | ${{ needs.build.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üîí Security | ${{ needs.security.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üåê API Test | ${{ needs.api-test.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üé® Web UI | ${{ needs.web.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
