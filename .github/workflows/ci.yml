name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  GO_VERSION: "1.25"
  NODE_VERSION: "20"

jobs:
  lint:
    name: ðŸ” Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Check formatting
        run: |
          UNFORMATTED=$(gofmt -l . | grep -v vendor || true)
          if [ -n "$UNFORMATTED" ]; then
            echo "::error::Code not formatted. Run 'gofmt -w .'"
            echo "$UNFORMATTED"
            exit 1
          fi

      - name: Install and run golangci-lint
        run: |
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@v2.8.0
          golangci-lint run --timeout=5m

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ” Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… All checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Lint checks failed" >> $GITHUB_STEP_SUMMARY
          fi

  test:
    name: ðŸ§ª Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run tests
        run: |
          go test -race -coverprofile=coverage.out -covermode=atomic ./... 2>&1 | tee test-output.txt
          echo "TEST_EXIT_CODE=${PIPESTATUS[0]}" >> $GITHUB_ENV

      - name: Upload coverage
        if: success()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          fail_ci_if_error: false

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract test stats
          PASSED=$(grep -c "^--- PASS" test-output.txt 2>/dev/null || echo "0")
          FAILED=$(grep -c "^--- FAIL" test-output.txt 2>/dev/null || echo "0")

          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY

          # Show coverage if available
          if [ -f coverage.out ]; then
            COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
            echo "| ðŸ“Š Coverage | $COVERAGE |" >> $GITHUB_STEP_SUMMARY
          fi

  build:
    name: ðŸ”¨ Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build packages
        run: go build ./...

      - name: Build server
        run: |
          go build -ldflags="-s -w" -o bin/server ./cmd/server
          ls -lh bin/server

      - name: Summary
        run: |
          echo "## ðŸ”¨ Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Binary | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          SIZE=$(ls -lh bin/server | awk '{print $5}')
          echo "| server | $SIZE |" >> $GITHUB_STEP_SUMMARY

  security:
    name: ðŸ”’ Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./... 2>&1 | tee vuln-output.txt || true

      - name: Summary
        run: |
          echo "## ðŸ”’ Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if grep -q "No vulnerabilities found" vuln-output.txt; then
            echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Review vulnerability report in logs" >> $GITHUB_STEP_SUMMARY
          fi

  api-test:
    name: ðŸŒ API Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build and start server
        run: |
          go build -o bin/server ./cmd/server
          CONFIG_PATH=configs/local.example.yml ./bin/server &

          # Wait for server
          for i in {1..30}; do
            if curl -s http://localhost:10101/health > /dev/null 2>&1; then
              echo "Server ready"
              break
            fi
            sleep 1
          done

      - name: Install Bruno CLI
        run: npm install -g @usebruno/cli

      - name: Run API tests
        run: |
          cd tests/bruno
          bru run --env memory 2>&1 | tee bruno-output.txt || true

      - name: Stop server
        if: always()
        run: pkill -f "bin/server" || true

      - name: Summary
        if: always()
        run: |
          echo "## ðŸŒ API Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "API tests executed against memory provider" >> $GITHUB_STEP_SUMMARY

  web:
    name: ðŸŽ¨ Web UI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Install & Build
        run: |
          cd web
          npm ci
          npm run build

      - name: Summary
        run: |
          echo "## ðŸŽ¨ Web UI Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "web/dist" ]; then
            SIZE=$(du -sh web/dist | cut -f1)
            echo "âœ… Build successful ($SIZE)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build failed" >> $GITHUB_STEP_SUMMARY
          fi

  # Final summary job
  summary:
    name: ðŸ“Š Summary
    needs: [lint, test, build, security, api-test, web]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## ðŸ“Š CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Lint | ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Test | ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¨ Build | ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security | ${{ needs.security.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ API Test | ${{ needs.api-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¨ Web UI | ${{ needs.web.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
