name: Cleanup

on:
    schedule:
        # Run monthly on the 1st at 00:00 UTC
        - cron: "0 0 1 * *"
    workflow_dispatch:

jobs:
    cleanup-ghcr:
        name: ðŸ§¹ Clean Old Container Images
        runs-on: ubuntu-latest

        permissions:
            packages: write

        steps:
            # Keep at least 60 versions (~2 months of daily builds)
            - name: Delete old untagged versions
              uses: actions/delete-package-versions@v5
              with:
                  package-name: wpd-message-gateway
                  package-type: container
                  min-versions-to-keep: 60
                  delete-only-untagged-versions: true

            # Keep at least 60 pre-release versions (~2 months)
            - name: Delete old pre-release versions
              uses: actions/delete-package-versions@v5
              with:
                  package-name: wpd-message-gateway
                  package-type: container
                  min-versions-to-keep: 60
                  delete-only-pre-release-versions: true

            - name: Summary
              run: |
                  echo "## ðŸ§¹ Cleanup Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… Old container images cleaned up" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Policy:**" >> $GITHUB_STEP_SUMMARY
                  echo "- Keep at least last 60 versions (~2 months)" >> $GITHUB_STEP_SUMMARY
                  echo "- Delete untagged images older than 2 months" >> $GITHUB_STEP_SUMMARY
                  echo "- Delete pre-release versions older than 2 months" >> $GITHUB_STEP_SUMMARY
